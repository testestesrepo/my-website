<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプルマーカーレスAR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2;
            pointer-events: none;
        }
        
        #ui {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        #controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 15px;
        }
        
        .control-btn {
            padding: 15px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }
        
        .control-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        .control-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .control-btn.secondary {
            background: #FF6B6B;
        }
        
        .control-btn.secondary:hover {
            background: #ff5252;
        }
        
        #status {
            position: fixed;
            bottom: 120px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }
        
        .hidden {
            display: none !important;
        }
        
        #instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 2000;
            max-width: 90vw;
        }
        
        #startBtn {
            margin-top: 20px;
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="instructions">
        <h2>📱 マーカーレスAR</h2>
        <p>カメラを使って3Dオブジェクトを配置します</p>
        <ul style="text-align: left; margin: 15px 0;">
            <li>🎯 画面をタップしてオブジェクト配置</li>
            <li>🔄 配置したオブジェクトをタップで削除</li>
            <li>🎨 複数の形状がランダムに配置されます</li>
        </ul>
        <button id="startBtn">ARを開始</button>
    </div>
    
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
    
    <div id="ui">
        <h3>🌟 マーカーレスAR</h3>
        <p>オブジェクト数: <span id="objectCount">0</span></p>
    </div>
    
    <div id="controls" class="hidden">
        <button class="control-btn" id="placeBtn">🎯 配置</button>
        <button class="control-btn secondary" id="clearBtn">🗑️ 全削除</button>
    </div>
    
    <div id="status" class="hidden">
        画面をタップしてオブジェクトを配置してください
    </div>

    <script>
        let video, canvas, ctx;
        let isARActive = false;
        let objects = [];
        let objectIdCounter = 0;
        
        // オブジェクトの種類定義
        const objectTypes = [
            { type: 'cube', color: '#FF6B6B', size: 40 },
            { type: 'circle', color: '#4ECDC4', size: 35 },
            { type: 'triangle', color: '#FFE66D', size: 45 },
            { type: 'diamond', color: '#95E1D3', size: 40 },
            { type: 'star', color: '#F38BA8', size: 50 }
        ];
        
        // DOM要素の取得
        const instructionsDiv = document.getElementById('instructions');
        const startBtn = document.getElementById('startBtn');
        const ui = document.getElementById('ui');
        const controls = document.getElementById('controls');
        const status = document.getElementById('status');
        const placeBtn = document.getElementById('placeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const objectCountSpan = document.getElementById('objectCount');
        
        // 初期化
        function init() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            // キャンバスサイズの設定
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // イベントリスナー
            startBtn.addEventListener('click', startAR);
            placeBtn.addEventListener('click', placeRandomObject);
            clearBtn.addEventListener('click', clearAllObjects);
            canvas.addEventListener('click', handleCanvasClick);
            
            // タッチイベント（モバイル対応）
            canvas.addEventListener('touchstart', handleTouch);
        }
        
        // キャンバスサイズ調整
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        // ARセッション開始
        async function startAR() {
            try {
                // カメラアクセス要求
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment', // 背面カメラ
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = stream;
                video.play();
                
                // UI切り替え
                instructionsDiv.classList.add('hidden');
                controls.classList.remove('hidden');
                status.classList.remove('hidden');
                
                isARActive = true;
                
                // 描画ループ開始
                requestAnimationFrame(render);
                
                status.textContent = '✅ ARが開始されました！画面をタップしてオブジェクトを配置';
                
            } catch (error) {
                console.error('カメラアクセスエラー:', error);
                alert('カメラにアクセスできませんでした。ブラウザの設定を確認してください。');
            }
        }
        
        // メインレンダリングループ
        function render() {
            if (!isARActive) return;
            
            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // オブジェクトを描画
            objects.forEach(obj => {
                drawObject(obj);
            });
            
            requestAnimationFrame(render);
        }
        
        // オブジェクト描画
        function drawObject(obj) {
            ctx.save();
            ctx.translate(obj.x, obj.y);
            ctx.rotate(obj.rotation);
            
            // 影の効果
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 5;
            ctx.shadowOffsetY = 5;
            
            ctx.fillStyle = obj.color;
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            
            switch(obj.type) {
                case 'cube':
                    drawCube(obj.size);
                    break;
                case 'circle':
                    drawCircle(obj.size);
                    break;
                case 'triangle':
                    drawTriangle(obj.size);
                    break;
                case 'diamond':
                    drawDiamond(obj.size);
                    break;
                case 'star':
                    drawStar(obj.size);
                    break;
            }
            
            ctx.restore();
            
            // アニメーション更新
            obj.rotation += obj.rotationSpeed;
            obj.scale = 1 + Math.sin(obj.animationTime) * 0.1;
            obj.animationTime += 0.05;
        }
        
        // 各形状の描画関数
        function drawCube(size) {
            const s = size / 2;
            ctx.fillRect(-s, -s, size, size);
            ctx.strokeRect(-s, -s, size, size);
        }
        
        function drawCircle(size) {
            ctx.beginPath();
            ctx.arc(0, 0, size / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
        }
        
        function drawTriangle(size) {
            const s = size / 2;
            ctx.beginPath();
            ctx.moveTo(0, -s);
            ctx.lineTo(-s, s);
            ctx.lineTo(s, s);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        
        function drawDiamond(size) {
            const s = size / 2;
            ctx.beginPath();
            ctx.moveTo(0, -s);
            ctx.lineTo(s, 0);
            ctx.lineTo(0, s);
            ctx.lineTo(-s, 0);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        
        function drawStar(size) {
            const s = size / 2;
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const angle = (i * 4 * Math.PI) / 5;
                const x = Math.cos(angle) * s;
                const y = Math.sin(angle) * s;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        
        // ランダムオブジェクト配置
        function placeRandomObject() {
            const objType = objectTypes[Math.floor(Math.random() * objectTypes.length)];
            const x = Math.random() * (canvas.width - 100) + 50;
            const y = Math.random() * (canvas.height - 200) + 100;
            
            addObject(x, y, objType);
        }
        
        // オブジェクト追加
        function addObject(x, y, objType) {
            const obj = {
                id: ++objectIdCounter,
                x: x,
                y: y,
                type: objType.type,
                color: objType.color,
                size: objType.size,
                rotation: 0,
                rotationSpeed: (Math.random() - 0.5) * 0.1,
                scale: 1,
                animationTime: 0
            };
            
            objects.push(obj);
            updateObjectCount();
            
            // フィードバック
            status.textContent = `🎉 ${obj.type}を配置しました！（オブジェクトをタップで削除）`;
            setTimeout(() => {
                status.textContent = '画面をタップしてオブジェクトを配置してください';
            }, 2000);
        }
        
        // キャンバスクリックハンドラ
        function handleCanvasClick(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // オブジェクトがクリックされたかチェック
            const clickedObject = findObjectAt(x, y);
            if (clickedObject) {
                removeObject(clickedObject.id);
            } else {
                // 新しいオブジェクトを配置
                const objType = objectTypes[Math.floor(Math.random() * objectTypes.length)];
                addObject(x, y, objType);
            }
        }
        
        // タッチイベントハンドラ
        function handleTouch(event) {
            event.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = event.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            const clickedObject = findObjectAt(x, y);
            if (clickedObject) {
                removeObject(clickedObject.id);
            } else {
                const objType = objectTypes[Math.floor(Math.random() * objectTypes.length)];
                addObject(x, y, objType);
            }
        }
        
        // 座標でオブジェクトを検索
        function findObjectAt(x, y) {
            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                const distance = Math.sqrt((x - obj.x) ** 2 + (y - obj.y) ** 2);
                if (distance < obj.size / 2) {
                    return obj;
                }
            }
            return null;
        }
        
        // オブジェクト削除
        function removeObject(id) {
            objects = objects.filter(obj => obj.id !== id);
            updateObjectCount();
            status.textContent = '🗑️ オブジェクトを削除しました';
            setTimeout(() => {
                status.textContent = '画面をタップしてオブジェクトを配置してください';
            }, 1500);
        }
        
        // 全オブジェクト削除
        function clearAllObjects() {
            objects = [];
            updateObjectCount();
            status.textContent = '🧹 すべてのオブジェクトを削除しました';
            setTimeout(() => {
                status.textContent = '画面をタップしてオブジェクトを配置してください';
            }, 2000);
        }
        
        // オブジェクトカウント更新
        function updateObjectCount() {
            objectCountSpan.textContent = objects.length;
        }
        
        // 初期化実行
        window.addEventListener('load', init);
    </script>
</body>
</html>