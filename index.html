<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¹ WebAR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 999;
            font-size: 14px;
            max-width: 300px;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .control-btn:hover {
            background: white;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading">
        <p>ã‚«ãƒ¡ãƒ©ã‚’åˆæœŸåŒ–ä¸­...</p>
        <p>ARã‚’é–‹å§‹ã™ã‚‹ã«ã¯ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
    </div>
    
    <div id="info">
        <h3>ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¹ WebAR</h3>
        <p>ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…ç½®</p>
        <p>ãƒ”ãƒ³ãƒã§ã‚ºãƒ¼ãƒ ã€ãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢</p>
    </div>
    
    <div id="controls">
        <button class="control-btn" onclick="addCube()">ğŸ² ã‚­ãƒ¥ãƒ¼ãƒ–è¿½åŠ </button>
        <button class="control-btn" onclick="addSphere()">âšª çƒä½“è¿½åŠ </button>
        <button class="control-btn" onclick="clearObjects()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        gesture-detector
        id="scene">
        
        <!-- ã‚¢ã‚»ãƒƒãƒˆå®šç¾© -->
        <a-assets>
            <a-mixin id="cube-mixin" 
                     geometry="primitive: box; width: 0.3; height: 0.3; depth: 0.3"
                     material="color: #FF6B6B; metalness: 0.1; roughness: 0.8"
                     animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"></a-mixin>
            
            <a-mixin id="sphere-mixin"
                     geometry="primitive: sphere; radius: 0.15"
                     material="color: #4ECDC4; metalness: 0.3; roughness: 0.4"
                     animation="property: position; to: 0 0.5 0; direction: alternate; loop: true; dur: 2000"></a-mixin>
        </a-assets>
        
        <!-- ç…§æ˜è¨­å®š -->
        <a-light type="ambient" color="#404040" intensity="0.5"></a-light>
        <a-light type="directional" position="1 1 1" color="#ffffff" intensity="0.8"></a-light>
        
        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
        <a-entity id="marker-anchor">
            <!-- åˆæœŸè¡¨ç¤ºç”¨ã®ãƒ›ãƒ­ã‚°ãƒ©ãƒ é¢¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
            <a-torus 
                position="0 0 -2" 
                color="#9C88FF" 
                radius="0.3" 
                radius-tubular="0.05"
                animation="property: rotation; to: 360 0 0; loop: true; dur: 3000"
                material="transparent: true; opacity: 0.8">
            </a-torus>
            
            <a-text 
                value="WebAR Demo" 
                position="0 -0.5 -2" 
                align="center" 
                color="#ffffff"
                font="dejavu"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 8000">
            </a-text>
        </a-entity>
        
        <!-- ã‚«ãƒ¡ãƒ© -->
        <a-camera 
            id="camera"
            camera 
            look-controls-enabled="false" 
            arjs-device-orientation-controls>
        </a-camera>
    </a-scene>

    <script>
        let objectCount = 0;
        let scene;
        let anchor;
        
        // ã‚·ãƒ¼ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            scene = document.querySelector('#scene');
            anchor = document.querySelector('#marker-anchor');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 2000);
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®
            scene.addEventListener('click', function(evt) {
                if (evt.target === scene.canvas) {
                    placeObjectAtScreenCenter();
                }
            });
        });
        
        // ç”»é¢ä¸­å¤®ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…ç½®
        function placeObjectAtScreenCenter() {
            const randomObject = Math.random() > 0.5 ? 'cube' : 'sphere';
            if (randomObject === 'cube') {
                addCube();
            } else {
                addSphere();
            }
        }
        
        // ã‚­ãƒ¥ãƒ¼ãƒ–è¿½åŠ 
        function addCube() {
            const cube = document.createElement('a-entity');
            cube.setAttribute('mixin', 'cube-mixin');
            cube.setAttribute('position', getRandomPosition());
            cube.setAttribute('id', 'cube-' + (++objectCount));
            cube.setAttribute('gesture-handler', '');
            anchor.appendChild(cube);
        }
        
        // çƒä½“è¿½åŠ 
        function addSphere() {
            const sphere = document.createElement('a-entity');
            sphere.setAttribute('mixin', 'sphere-mixin');
            sphere.setAttribute('position', getRandomPosition());
            sphere.setAttribute('id', 'sphere-' + (++objectCount));
            sphere.setAttribute('gesture-handler', '');
            anchor.appendChild(sphere);
        }
        
        // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã‚’ç”Ÿæˆ
        function getRandomPosition() {
            const x = (Math.random() - 0.5) * 2;
            const y = Math.random() * 0.5;
            const z = -1 - Math.random() * 2;
            return `${x} ${y} ${z}`;
        }
        
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢
        function clearObjects() {
            const objects = anchor.querySelectorAll('[id^="cube-"], [id^="sphere-"]');
            objects.forEach(obj => obj.remove());
            objectCount = 0;
        }
        
        // ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        AFRAME.registerComponent('gesture-handler', {
            init: function() {
                this.el.addEventListener('click', (evt) => {
                    evt.stopPropagation();
                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å°‘ã—å‹•ã‹ã™
                    const currentPos = this.el.getAttribute('position');
                    this.el.setAttribute('animation', {
                        property: 'position',
                        to: `${currentPos.x} ${currentPos.y + 0.2} ${currentPos.z}`,
                        dur: 500,
                        direction: 'alternate',
                        loop: 1
                    });
                });
            }
        });
        
        // ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼æ¤œå‡ºå™¨
        AFRAME.registerComponent('gesture-detector', {
            init: function() {
                this.onTouchStart = this.onTouchStart.bind(this);
                this.onTouchEnd = this.onTouchEnd.bind(this);
                this.el.addEventListener('touchstart', this.onTouchStart);
                this.el.addEventListener('touchend', this.onTouchEnd);
            },
            
            onTouchStart: function(evt) {
                // ã‚¿ãƒƒãƒé–‹å§‹æ™‚ã®å‡¦ç†
            },
            
            onTouchEnd: function(evt) {
                // ã‚¿ãƒƒãƒçµ‚äº†æ™‚ã®å‡¦ç†
            }
        });
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(e) {
            console.error('WebAR Error:', e);
            document.getElementById('info').innerHTML = 
                '<h3>ã‚¨ãƒ©ãƒ¼</h3><p>WebARã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HTTPSãŒå¿…è¦ã§ã™ã€‚</p>';
        });
        
        // ã‚«ãƒ¡ãƒ©æ¨©é™ãƒã‚§ãƒƒã‚¯
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                console.log('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯');
                stream.getTracks().forEach(track => track.stop());
            })
            .catch(function(err) {
                console.error('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦:', err);
                document.getElementById('info').innerHTML = 
                    '<h3>ã‚«ãƒ¡ãƒ©ãŒå¿…è¦</h3><p>WebARã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>';
            });
    </script>
</body>
</html>
