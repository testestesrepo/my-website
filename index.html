<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR デモ（簡易版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 999;
            font-size: 12px;
            max-width: 250px;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.9);
            border: 1px solid #ccc;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .control-btn:active {
            background: rgba(200,200,200,0.9);
        }
        
        #debug {
            position: absolute;
            bottom: 80px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            z-index: 999;
            font-size: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="info">
        <h4>📱 WebAR テスト</h4>
        <p>HIROマーカーをカメラに向けてください</p>
        <p id="status">初期化中...</p>
    </div>
    
    <div id="debug">
        <div id="debug-info">デバッグ情報</div>
    </div>
    
    <div id="controls">
        <button class="control-btn" onclick="changeColor()">🎨 色変更</button>
        <button class="control-btn" onclick="toggleRotation()">🔄 回転</button>
        <button class="control-btn" onclick="resetCamera()">📷 リセット</button>
    </div>

    <!-- ARシーン -->
    <a-scene
        id="scene"
        embedded
        arjs="sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;">
        
        <a-marker preset="hiro" id="markerA">
            <a-entity id="bowser" scale="1 1 1">
                <!-- シンプルなキューブ -->
                <a-box 
                    id="main-box"
                    position="0 0.5 0" 
                    rotation="0 45 0"
                    color="#FF0000" 
                    scale="0.5 0.5 0.5"
                    animation="property: rotation; to: 0 405 0; loop: true; dur: 10000; pauseEvents: pause; resumeEvents: resume"
                    shadow>
                </a-box>
                
                <!-- テキスト -->
                <a-text 
                    value="Hello AR!"
                    position="0 1 0"
                    align="center"
                    color="white"
                    font="kelsonsans"
                    scale="3 3 3">
                </a-text>
                
                <!-- 地面 -->
                <a-plane 
                    position="0 0 0" 
                    rotation="-90 0 0" 
                    width="2" 
                    height="2" 
                    color="#7BC8A4" 
                    shadow>
                </a-plane>
            </a-entity>
        </a-marker>
        
        <!-- カメラ -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        let scene, marker, box;
        let colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];
        let colorIndex = 0;
        let rotationEnabled = true;
        
        // DOM読み込み完了後の初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM読み込み完了');
            updateDebug('DOM loaded');
            
            // 要素取得
            scene = document.querySelector('#scene');
            marker = document.querySelector('#markerA');
            box = document.querySelector('#main-box');
            
            if (!scene || !marker || !box) {
                console.error('要素が見つかりません');
                updateDebug('ERROR: Elements not found');
                return;
            }
            
            updateDebug('Elements found');
            
            // マーカーイベント
            marker.addEventListener('markerFound', function() {
                console.log('マーカー発見');
                updateDebug('Marker found!');
                document.getElementById('status').textContent = 'マーカー検出中 ✅';
            });
            
            marker.addEventListener('markerLost', function() {
                console.log('マーカー消失');
                updateDebug('Marker lost');
                document.getElementById('status').textContent = 'マーカーを探しています 🔍';
            });
            
            // シーンイベント
            scene.addEventListener('arjs-video-loaded', function() {
                console.log('カメラ映像読み込み完了');
                updateDebug('Camera loaded');
                document.getElementById('status').textContent = 'カメラ準備完了 📹';
            });
            
            scene.addEventListener('camera-error', function(error) {
                console.error('カメラエラー:', error);
                updateDebug('Camera error: ' + error);
                document.getElementById('status').textContent = 'カメラエラー ❌';
            });
            
            // 初期化完了
            setTimeout(() => {
                updateDebug('Init complete');
                document.getElementById('status').textContent = 'HIROマーカーをカメラに向けてください';
            }, 2000);
        });
        
        // 色変更
        function changeColor() {
            if (!box) return;
            colorIndex = (colorIndex + 1) % colors.length;
            box.setAttribute('color', colors[colorIndex]);
            updateDebug('Color changed to: ' + colors[colorIndex]);
        }
        
        // 回転切り替え
        function toggleRotation() {
            if (!box) return;
            rotationEnabled = !rotationEnabled;
            
            if (rotationEnabled) {
                box.emit('resume');
                updateDebug('Rotation enabled');
            } else {
                box.emit('pause');
                updateDebug('Rotation paused');
            }
        }
        
        // カメラリセット
        function resetCamera() {
            console.log('カメラリセット試行');
            updateDebug('Camera reset requested');
            
            // シーンを再初期化
            if (scene) {
                scene.setAttribute('arjs', 'sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;');
            }
        }
        
        // デバッグ情報更新
        function updateDebug(message) {
            const debugElement = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugElement.innerHTML = `${timestamp}: ${message}`;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // エラーハンドリング
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
            updateDebug('Error: ' + e.message);
            document.getElementById('status').textContent = 'エラーが発生しました';
        });
        
        // ページ可視性変更
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                updateDebug('Page hidden');
            } else {
                updateDebug('Page visible');
            }
        });
        
        // カメラ権限チェック
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { min: 640, ideal: 1280 },
                height: { min: 480, ideal: 960 }
            } 
        })
        .then(function(stream) {
            console.log('カメラ権限OK');
            updateDebug('Camera permission granted');
            // ストリームを即座に停止（AR.jsが管理するため）
            stream.getTracks().forEach(track => track.stop());
        })
        .catch(function(err) {
            console.error('カメラ権限エラー:', err);
            updateDebug('Camera permission denied: ' + err.name);
            document.getElementById('status').innerHTML = 
                `カメラ権限が必要です<br><small>${err.message}</small>`;
        });
        
        // 初期化ログ
        updateDebug('Script loaded');
        console.log('WebAR Script initialized');
        console.log('Protocol:', window.location.protocol);
        console.log('User Agent:', navigator.userAgent);
    </script>
</body>
</html>
