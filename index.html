<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¹WebAR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
        }
        
        #ui {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        
        #instructions {
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        
        #startButton {
            display: block;
            margin: 0 auto;
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #startButton:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        #startButton:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        #status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }
        
        #placeButton {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: #FF6B6B;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1000;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        a-scene {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="instructions">
            <h2>ğŸŒŸ ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¹WebAR</h2>
            <p>åºŠã‚„å¹³é¢ã‚’æ¤œå‡ºã—ã¦3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…ç½®ã—ã¾ã™</p>
        </div>
        <button id="startButton">ARã‚’é–‹å§‹</button>
    </div>
    
    <div id="status">
        WebXRã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ç¢ºèªä¸­...
    </div>
    
    <button id="placeButton">ğŸ¯ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…ç½®</button>
    
    <a-scene 
        id="scene"
        embedded 
        style="height: 100vh; width: 100vw;"
        webxr="requiredFeatures: hit-test,local-floor;
               optionalFeatures: dom-overlay,unbounded;
               overlayElement: #ui;"
        renderer="colorManagement: true; physicallyCorrectLights: true;"
        background="color: transparent;">
        
        <!-- ã‚¢ã‚»ãƒƒãƒˆå®šç¾© -->
        <a-assets>
            <a-mixin id="cube" 
                     geometry="primitive: box; width: 0.1; height: 0.1; depth: 0.1"
                     material="color: #FF6B6B; roughness: 0.3; metalness: 0.1"
                     animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
            </a-mixin>
            
            <a-mixin id="sphere" 
                     geometry="primitive: sphere; radius: 0.05"
                     material="color: #4ECDC4; roughness: 0.2; metalness: 0.3"
                     animation="property: position; to: 0 0.2 0; dir: alternate; loop: true; dur: 2000">
            </a-mixin>
            
            <a-mixin id="pyramid" 
                     geometry="primitive: cone; radiusBottom: 0.05; radiusTop: 0; height: 0.1"
                     material="color: #FFE66D; roughness: 0.4; metalness: 0.2"
                     animation="property: scale; to: 1.5 1.5 1.5; dir: alternate; loop: true; dur: 1500">
            </a-mixin>
        </a-assets>
        
        <!-- ç…§æ˜ -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light type="directional" 
                 position="1 1 1" 
                 color="#ffffff" 
                 intensity="0.8"
                 shadow="cast: true; type: pcf">
        </a-light>
        
        <!-- ã‚«ãƒ¡ãƒ© -->
        <a-camera 
            id="camera"
            position="0 1.6 0"
            look-controls="enabled: false"
            wasd-controls="enabled: false"
            cursor="rayOrigin: mouse">
        </a-camera>
        
        <!-- åºŠé¢ã®ãƒ—ãƒ¬ãƒ¼ãƒ³ï¼ˆç›®å®‰ç”¨ï¼‰ -->
        <a-plane 
            id="floor" 
            position="0 0 0" 
            rotation="-90 0 0" 
            width="4" 
            height="4" 
            material="color: #333; transparent: true; opacity: 0.1"
            visible="false">
        </a-plane>
    </a-scene>

    <script>
        let scene, camera;
        let isARActive = false;
        let objectCount = 0;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        
        // UIè¦ç´ ã®å–å¾—
        const startButton = document.getElementById('startButton');
        const placeButton = document.getElementById('placeButton');
        const statusDiv = document.getElementById('status');
        const ui = document.getElementById('ui');
        
        // A-Frameã‚·ãƒ¼ãƒ³ã®å–å¾—
        scene = document.getElementById('scene');
        
        // WebXRã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
        async function checkWebXRSupport() {
            if (!navigator.xr) {
                statusDiv.textContent = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯WebXRã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
                startButton.disabled = true;
                return false;
            }
            
            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    statusDiv.textContent = 'âœ… WebXR ARå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã§ã™ï¼';
                    return true;
                } else {
                    statusDiv.textContent = 'âŒ ARæ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“';
                    startButton.disabled = true;
                    return false;
                }
            } catch (error) {
                console.error('WebXRã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                statusDiv.textContent = 'âŒ WebXRãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                startButton.disabled = true;
                return false;
            }
        }
        
        // ARã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
        async function startAR() {
            try {
                statusDiv.textContent = 'ğŸ”„ ARã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...';
                startButton.disabled = true;
                
                // A-Frameã®WebXRã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ARã‚’é–‹å§‹
                const sceneEl = document.querySelector('a-scene');
                if (sceneEl.xrSession) {
                    statusDiv.textContent = 'âš ï¸ ARã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã¾ã™';
                    return;
                }
                
                // WebXRã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ã‚’è©¦è¡Œ
                await sceneEl.enterVR();
                
                isARActive = true;
                statusDiv.textContent = 'ğŸ“± ã‚«ãƒ¡ãƒ©ã‚’åºŠã‚„å¹³é¢ã«å‘ã‘ã¦ãã ã•ã„';
                placeButton.style.display = 'block';
                ui.style.display = 'none';
                
            } catch (error) {
                console.error('ARã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                statusDiv.textContent = 'âŒ ARã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ';
                startButton.disabled = false;
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ã§å‹•ä½œ
                startCameraFallback();
            }
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆWebXRãŒä½¿ç”¨ã§ããªã„å ´åˆï¼‰
        function startCameraFallback() {
            statusDiv.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­ï¼ˆç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…ç½®ï¼‰';
            placeButton.style.display = 'block';
            ui.style.display = 'none';
            isARActive = true;
            
            // åºŠé¢ã‚’è¡¨ç¤º
            const floor = document.getElementById('floor');
            floor.setAttribute('visible', true);
        }
        
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…ç½®
        function placeObject() {
            if (!isARActive) return;
            
            objectCount++;
            const objectTypes = ['cube', 'sphere', 'pyramid'];
            const randomType = objectTypes[Math.floor(Math.random() * objectTypes.length)];
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«é…ç½®
            const x = (Math.random() - 0.5) * 2;
            const z = (Math.random() - 0.5) * 2;
            const y = 0.05;
            
            // æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
            const entity = document.createElement('a-entity');
            entity.setAttribute('mixin', randomType);
            entity.setAttribute('position', `${x} ${y} ${z}`);
            entity.setAttribute('id', `object-${objectCount}`);
            
            // ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ 
            entity.addEventListener('click', function() {
                this.remove();
            });
            
            scene.appendChild(entity);
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            statusDiv.textContent = `ğŸ‰ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ${objectCount}ã‚’é…ç½®ã—ã¾ã—ãŸï¼ï¼ˆã‚¿ãƒƒãƒ—ã§å‰Šé™¤ï¼‰`;
            
            // 3ç§’å¾Œã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å…ƒã«æˆ»ã™
            setTimeout(() => {
                if (isARActive) {
                    statusDiv.textContent = 'ğŸ‘† ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…ç½®';
                }
            }, 3000);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        startButton.addEventListener('click', startAR);
        placeButton.addEventListener('click', placeObject);
        
        // ç”»é¢ã‚¿ãƒƒãƒ—ã§ã‚‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…ç½®
        document.addEventListener('click', function(event) {
            if (isARActive && !event.target.closest('button')) {
                placeObject();
            }
        });
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', async function() {
            await checkWebXRSupport();
        });
        
        // A-Frameã‚·ãƒ¼ãƒ³ã®æº–å‚™å®Œäº†æ™‚
        scene.addEventListener('loaded', function() {
            console.log('A-Frameã‚·ãƒ¼ãƒ³ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        });
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(e) {
            console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e.error);
            statusDiv.textContent = 'âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        });
    </script>
</body>
</html>