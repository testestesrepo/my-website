<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR ãƒ‡ãƒ¢ï¼ˆç°¡æ˜“ç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 999;
            font-size: 12px;
            max-width: 250px;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.9);
            border: 1px solid #ccc;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .control-btn:active {
            background: rgba(200,200,200,0.9);
        }
        
        #debug {
            position: absolute;
            bottom: 80px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            z-index: 999;
            font-size: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="info">
        <h4>ğŸ“± WebAR ãƒ†ã‚¹ãƒˆ</h4>
        <p>HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„</p>
        <p id="status">åˆæœŸåŒ–ä¸­...</p>
    </div>
    
    <div id="debug">
        <div id="debug-info">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</div>
    </div>
    
    <div id="controls">
        <button class="control-btn" onclick="changeColor()">ğŸ¨ è‰²å¤‰æ›´</button>
        <button class="control-btn" onclick="toggleRotation()">ğŸ”„ å›è»¢</button>
        <button class="control-btn" onclick="resetCamera()">ğŸ“· ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <!-- ARã‚·ãƒ¼ãƒ³ -->
    <a-scene
        id="scene"
        embedded
        arjs="sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;">
        
        <a-marker preset="hiro" id="markerA">
            <a-entity id="bowser" scale="1 1 1">
                <!-- ã‚·ãƒ³ãƒ—ãƒ«ãªã‚­ãƒ¥ãƒ¼ãƒ– -->
                <a-box 
                    id="main-box"
                    position="0 0.5 0" 
                    rotation="0 45 0"
                    color="#FF0000" 
                    scale="0.5 0.5 0.5"
                    animation="property: rotation; to: 0 405 0; loop: true; dur: 10000; pauseEvents: pause; resumeEvents: resume"
                    shadow>
                </a-box>
                
                <!-- ãƒ†ã‚­ã‚¹ãƒˆ -->
                <a-text 
                    value="Hello AR!"
                    position="0 1 0"
                    align="center"
                    color="white"
                    font="kelsonsans"
                    scale="3 3 3">
                </a-text>
                
                <!-- åœ°é¢ -->
                <a-plane 
                    position="0 0 0" 
                    rotation="-90 0 0" 
                    width="2" 
                    height="2" 
                    color="#7BC8A4" 
                    shadow>
                </a-plane>
            </a-entity>
        </a-marker>
        
        <!-- ã‚«ãƒ¡ãƒ© -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        let scene, marker, box;
        let colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];
        let colorIndex = 0;
        let rotationEnabled = true;
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMèª­ã¿è¾¼ã¿å®Œäº†');
            updateDebug('DOM loaded');
            
            // è¦ç´ å–å¾—
            scene = document.querySelector('#scene');
            marker = document.querySelector('#markerA');
            box = document.querySelector('#main-box');
            
            if (!scene || !marker || !box) {
                console.error('è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                updateDebug('ERROR: Elements not found');
                return;
            }
            
            updateDebug('Elements found');
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
            marker.addEventListener('markerFound', function() {
                console.log('ãƒãƒ¼ã‚«ãƒ¼ç™ºè¦‹');
                updateDebug('Marker found!');
                document.getElementById('status').textContent = 'ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºä¸­ âœ…';
            });
            
            marker.addEventListener('markerLost', function() {
                console.log('ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±');
                updateDebug('Marker lost');
                document.getElementById('status').textContent = 'ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™ ğŸ”';
            });
            
            // ã‚·ãƒ¼ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            scene.addEventListener('arjs-video-loaded', function() {
                console.log('ã‚«ãƒ¡ãƒ©æ˜ åƒèª­ã¿è¾¼ã¿å®Œäº†');
                updateDebug('Camera loaded');
                document.getElementById('status').textContent = 'ã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº† ğŸ“¹';
            });
            
            scene.addEventListener('camera-error', function(error) {
                console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', error);
                updateDebug('Camera error: ' + error);
                document.getElementById('status').textContent = 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ âŒ';
            });
            
            // åˆæœŸåŒ–å®Œäº†
            setTimeout(() => {
                updateDebug('Init complete');
                document.getElementById('status').textContent = 'HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„';
            }, 2000);
        });
        
        // è‰²å¤‰æ›´
        function changeColor() {
            if (!box) return;
            colorIndex = (colorIndex + 1) % colors.length;
            box.setAttribute('color', colors[colorIndex]);
            updateDebug('Color changed to: ' + colors[colorIndex]);
        }
        
        // å›è»¢åˆ‡ã‚Šæ›¿ãˆ
        function toggleRotation() {
            if (!box) return;
            rotationEnabled = !rotationEnabled;
            
            if (rotationEnabled) {
                box.emit('resume');
                updateDebug('Rotation enabled');
            } else {
                box.emit('pause');
                updateDebug('Rotation paused');
            }
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒªã‚»ãƒƒãƒˆ
        function resetCamera() {
            console.log('ã‚«ãƒ¡ãƒ©ãƒªã‚»ãƒƒãƒˆè©¦è¡Œ');
            updateDebug('Camera reset requested');
            
            // ã‚·ãƒ¼ãƒ³ã‚’å†åˆæœŸåŒ–
            if (scene) {
                scene.setAttribute('arjs', 'sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;');
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
        function updateDebug(message) {
            const debugElement = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugElement.innerHTML = `${timestamp}: ${message}`;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
            updateDebug('Error: ' + e.message);
            document.getElementById('status').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        });
        
        // ãƒšãƒ¼ã‚¸å¯è¦–æ€§å¤‰æ›´
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                updateDebug('Page hidden');
            } else {
                updateDebug('Page visible');
            }
        });
        
        // ã‚«ãƒ¡ãƒ©æ¨©é™ãƒã‚§ãƒƒã‚¯
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { min: 640, ideal: 1280 },
                height: { min: 480, ideal: 960 }
            } 
        })
        .then(function(stream) {
            console.log('ã‚«ãƒ¡ãƒ©æ¨©é™OK');
            updateDebug('Camera permission granted');
            // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å³åº§ã«åœæ­¢ï¼ˆAR.jsãŒç®¡ç†ã™ã‚‹ãŸã‚ï¼‰
            stream.getTracks().forEach(track => track.stop());
        })
        .catch(function(err) {
            console.error('ã‚«ãƒ¡ãƒ©æ¨©é™ã‚¨ãƒ©ãƒ¼:', err);
            updateDebug('Camera permission denied: ' + err.name);
            document.getElementById('status').innerHTML = 
                `ã‚«ãƒ¡ãƒ©æ¨©é™ãŒå¿…è¦ã§ã™<br><small>${err.message}</small>`;
        });
        
        // åˆæœŸåŒ–ãƒ­ã‚°
        updateDebug('Script loaded');
        console.log('WebAR Script initialized');
        console.log('Protocol:', window.location.protocol);
        console.log('User Agent:', navigator.userAgent);
    </script>
</body>
</html>
