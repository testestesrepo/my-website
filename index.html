<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マーカーレスWebAR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
        }
        
        #ui {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        
        #instructions {
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        
        #startButton {
            display: block;
            margin: 0 auto;
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #startButton:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        #startButton:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        #status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }
        
        #placeButton {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: #FF6B6B;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1000;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        a-scene {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="instructions">
            <h2>🌟 マーカーレスWebAR</h2>
            <p>床や平面を検出して3Dオブジェクトを配置します</p>
        </div>
        <button id="startButton">ARを開始</button>
    </div>
    
    <div id="status">
        WebXRをサポートしているか確認中...
    </div>
    
    <button id="placeButton">🎯 オブジェクトを配置</button>
    
    <a-scene 
        id="scene"
        embedded 
        style="height: 100vh; width: 100vw;"
        webxr="requiredFeatures: hit-test,local-floor;
               optionalFeatures: dom-overlay,unbounded;
               overlayElement: #ui;"
        renderer="colorManagement: true; physicallyCorrectLights: true;"
        background="color: transparent;">
        
        <!-- アセット定義 -->
        <a-assets>
            <a-mixin id="cube" 
                     geometry="primitive: box; width: 0.1; height: 0.1; depth: 0.1"
                     material="color: #FF6B6B; roughness: 0.3; metalness: 0.1"
                     animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
            </a-mixin>
            
            <a-mixin id="sphere" 
                     geometry="primitive: sphere; radius: 0.05"
                     material="color: #4ECDC4; roughness: 0.2; metalness: 0.3"
                     animation="property: position; to: 0 0.2 0; dir: alternate; loop: true; dur: 2000">
            </a-mixin>
            
            <a-mixin id="pyramid" 
                     geometry="primitive: cone; radiusBottom: 0.05; radiusTop: 0; height: 0.1"
                     material="color: #FFE66D; roughness: 0.4; metalness: 0.2"
                     animation="property: scale; to: 1.5 1.5 1.5; dir: alternate; loop: true; dur: 1500">
            </a-mixin>
        </a-assets>
        
        <!-- 照明 -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light type="directional" 
                 position="1 1 1" 
                 color="#ffffff" 
                 intensity="0.8"
                 shadow="cast: true; type: pcf">
        </a-light>
        
        <!-- カメラ -->
        <a-camera 
            id="camera"
            position="0 1.6 0"
            look-controls="enabled: false"
            wasd-controls="enabled: false"
            cursor="rayOrigin: mouse">
        </a-camera>
        
        <!-- 床面のプレーン（目安用） -->
        <a-plane 
            id="floor" 
            position="0 0 0" 
            rotation="-90 0 0" 
            width="4" 
            height="4" 
            material="color: #333; transparent: true; opacity: 0.1"
            visible="false">
        </a-plane>
    </a-scene>

    <script>
        let scene, camera;
        let isARActive = false;
        let objectCount = 0;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        
        // UI要素の取得
        const startButton = document.getElementById('startButton');
        const placeButton = document.getElementById('placeButton');
        const statusDiv = document.getElementById('status');
        const ui = document.getElementById('ui');
        
        // A-Frameシーンの取得
        scene = document.getElementById('scene');
        
        // WebXRサポートチェック
        async function checkWebXRSupport() {
            if (!navigator.xr) {
                statusDiv.textContent = '❌ このブラウザはWebXRをサポートしていません';
                startButton.disabled = true;
                return false;
            }
            
            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    statusDiv.textContent = '✅ WebXR AR対応デバイスです！';
                    return true;
                } else {
                    statusDiv.textContent = '❌ AR機能がサポートされていません';
                    startButton.disabled = true;
                    return false;
                }
            } catch (error) {
                console.error('WebXRサポートチェックエラー:', error);
                statusDiv.textContent = '❌ WebXRチェック中にエラーが発生しました';
                startButton.disabled = true;
                return false;
            }
        }
        
        // ARセッション開始
        async function startAR() {
            try {
                statusDiv.textContent = '🔄 ARセッションを開始しています...';
                startButton.disabled = true;
                
                // A-FrameのWebXRシステムを使用してARを開始
                const sceneEl = document.querySelector('a-scene');
                if (sceneEl.xrSession) {
                    statusDiv.textContent = '⚠️ ARセッションは既に開始されています';
                    return;
                }
                
                // WebXRセッションの開始を試行
                await sceneEl.enterVR();
                
                isARActive = true;
                statusDiv.textContent = '📱 カメラを床や平面に向けてください';
                placeButton.style.display = 'block';
                ui.style.display = 'none';
                
            } catch (error) {
                console.error('ARセッション開始エラー:', error);
                statusDiv.textContent = '❌ ARセッションの開始に失敗しました';
                startButton.disabled = false;
                
                // フォールバック: 通常のカメラビューで動作
                startCameraFallback();
            }
        }
        
        // カメラフォールバック（WebXRが使用できない場合）
        function startCameraFallback() {
            statusDiv.textContent = '📷 カメラモードで動作中（画面をタップしてオブジェクトを配置）';
            placeButton.style.display = 'block';
            ui.style.display = 'none';
            isARActive = true;
            
            // 床面を表示
            const floor = document.getElementById('floor');
            floor.setAttribute('visible', true);
        }
        
        // オブジェクトの配置
        function placeObject() {
            if (!isARActive) return;
            
            objectCount++;
            const objectTypes = ['cube', 'sphere', 'pyramid'];
            const randomType = objectTypes[Math.floor(Math.random() * objectTypes.length)];
            
            // ランダムな位置に配置
            const x = (Math.random() - 0.5) * 2;
            const z = (Math.random() - 0.5) * 2;
            const y = 0.05;
            
            // 新しいオブジェクトを作成
            const entity = document.createElement('a-entity');
            entity.setAttribute('mixin', randomType);
            entity.setAttribute('position', `${x} ${y} ${z}`);
            entity.setAttribute('id', `object-${objectCount}`);
            
            // クリックで削除する機能を追加
            entity.addEventListener('click', function() {
                this.remove();
            });
            
            scene.appendChild(entity);
            
            // フィードバック
            statusDiv.textContent = `🎉 オブジェクト${objectCount}を配置しました！（タップで削除）`;
            
            // 3秒後にステータスを元に戻す
            setTimeout(() => {
                if (isARActive) {
                    statusDiv.textContent = '👆 画面をタップしてオブジェクトを配置';
                }
            }, 3000);
        }
        
        // イベントリスナー
        startButton.addEventListener('click', startAR);
        placeButton.addEventListener('click', placeObject);
        
        // 画面タップでもオブジェクトを配置
        document.addEventListener('click', function(event) {
            if (isARActive && !event.target.closest('button')) {
                placeObject();
            }
        });
        
        // ページ読み込み時の初期化
        window.addEventListener('load', async function() {
            await checkWebXRSupport();
        });
        
        // A-Frameシーンの準備完了時
        scene.addEventListener('loaded', function() {
            console.log('A-Frameシーンが読み込まれました');
        });
        
        // エラーハンドリング
        window.addEventListener('error', function(e) {
            console.error('エラーが発生しました:', e.error);
            statusDiv.textContent = '❌ アプリケーションエラーが発生しました';
        });
    </script>
</body>
</html>