<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マーカーレス WebAR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 999;
            font-size: 14px;
            max-width: 300px;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .control-btn:hover {
            background: white;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading">
        <p>カメラを初期化中...</p>
        <p>ARを開始するには画面をタップしてください</p>
    </div>
    
    <div id="info">
        <h3>マーカーレス WebAR</h3>
        <p>画面をタップして3Dオブジェクトを配置</p>
        <p>ピンチでズーム、ドラッグで回転</p>
    </div>
    
    <div id="controls">
        <button class="control-btn" onclick="addCube()">🎲 キューブ追加</button>
        <button class="control-btn" onclick="addSphere()">⚪ 球体追加</button>
        <button class="control-btn" onclick="clearObjects()">🗑️ クリア</button>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        gesture-detector
        id="scene">
        
        <!-- アセット定義 -->
        <a-assets>
            <a-mixin id="cube-mixin" 
                     geometry="primitive: box; width: 0.3; height: 0.3; depth: 0.3"
                     material="color: #FF6B6B; metalness: 0.1; roughness: 0.8"
                     animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"></a-mixin>
            
            <a-mixin id="sphere-mixin"
                     geometry="primitive: sphere; radius: 0.15"
                     material="color: #4ECDC4; metalness: 0.3; roughness: 0.4"
                     animation="property: position; to: 0 0.5 0; direction: alternate; loop: true; dur: 2000"></a-mixin>
        </a-assets>
        
        <!-- 照明設定 -->
        <a-light type="ambient" color="#404040" intensity="0.5"></a-light>
        <a-light type="directional" position="1 1 1" color="#ffffff" intensity="0.8"></a-light>
        
        <!-- デフォルトオブジェクト -->
        <a-entity id="marker-anchor">
            <!-- 初期表示用のホログラム風オブジェクト -->
            <a-torus 
                position="0 0 -2" 
                color="#9C88FF" 
                radius="0.3" 
                radius-tubular="0.05"
                animation="property: rotation; to: 360 0 0; loop: true; dur: 3000"
                material="transparent: true; opacity: 0.8">
            </a-torus>
            
            <a-text 
                value="WebAR Demo" 
                position="0 -0.5 -2" 
                align="center" 
                color="#ffffff"
                font="dejavu"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 8000">
            </a-text>
        </a-entity>
        
        <!-- カメラ -->
        <a-camera 
            id="camera"
            camera 
            look-controls-enabled="false" 
            arjs-device-orientation-controls>
        </a-camera>
    </a-scene>

    <script>
        let objectCount = 0;
        let scene;
        let anchor;
        
        // シーン初期化
        document.addEventListener('DOMContentLoaded', function() {
            scene = document.querySelector('#scene');
            anchor = document.querySelector('#marker-anchor');
            
            // ローディング非表示
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 2000);
            
            // タッチイベントでオブジェクト配置
            scene.addEventListener('click', function(evt) {
                if (evt.target === scene.canvas) {
                    placeObjectAtScreenCenter();
                }
            });
        });
        
        // 画面中央にオブジェクトを配置
        function placeObjectAtScreenCenter() {
            const randomObject = Math.random() > 0.5 ? 'cube' : 'sphere';
            if (randomObject === 'cube') {
                addCube();
            } else {
                addSphere();
            }
        }
        
        // キューブ追加
        function addCube() {
            const cube = document.createElement('a-entity');
            cube.setAttribute('mixin', 'cube-mixin');
            cube.setAttribute('position', getRandomPosition());
            cube.setAttribute('id', 'cube-' + (++objectCount));
            cube.setAttribute('gesture-handler', '');
            anchor.appendChild(cube);
        }
        
        // 球体追加
        function addSphere() {
            const sphere = document.createElement('a-entity');
            sphere.setAttribute('mixin', 'sphere-mixin');
            sphere.setAttribute('position', getRandomPosition());
            sphere.setAttribute('id', 'sphere-' + (++objectCount));
            sphere.setAttribute('gesture-handler', '');
            anchor.appendChild(sphere);
        }
        
        // ランダムな位置を生成
        function getRandomPosition() {
            const x = (Math.random() - 0.5) * 2;
            const y = Math.random() * 0.5;
            const z = -1 - Math.random() * 2;
            return `${x} ${y} ${z}`;
        }
        
        // オブジェクトをクリア
        function clearObjects() {
            const objects = anchor.querySelectorAll('[id^="cube-"], [id^="sphere-"]');
            objects.forEach(obj => obj.remove());
            objectCount = 0;
        }
        
        // ジェスチャーハンドラー（簡易版）
        AFRAME.registerComponent('gesture-handler', {
            init: function() {
                this.el.addEventListener('click', (evt) => {
                    evt.stopPropagation();
                    // クリックされたオブジェクトを少し動かす
                    const currentPos = this.el.getAttribute('position');
                    this.el.setAttribute('animation', {
                        property: 'position',
                        to: `${currentPos.x} ${currentPos.y + 0.2} ${currentPos.z}`,
                        dur: 500,
                        direction: 'alternate',
                        loop: 1
                    });
                });
            }
        });
        
        // ジェスチャー検出器
        AFRAME.registerComponent('gesture-detector', {
            init: function() {
                this.onTouchStart = this.onTouchStart.bind(this);
                this.onTouchEnd = this.onTouchEnd.bind(this);
                this.el.addEventListener('touchstart', this.onTouchStart);
                this.el.addEventListener('touchend', this.onTouchEnd);
            },
            
            onTouchStart: function(evt) {
                // タッチ開始時の処理
            },
            
            onTouchEnd: function(evt) {
                // タッチ終了時の処理
            }
        });
        
        // エラーハンドリング
        window.addEventListener('error', function(e) {
            console.error('WebAR Error:', e);
            document.getElementById('info').innerHTML = 
                '<h3>エラー</h3><p>WebARの初期化に失敗しました。HTTPSが必要です。</p>';
        });
        
        // カメラ権限チェック
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                console.log('カメラアクセス許可');
                stream.getTracks().forEach(track => track.stop());
            })
            .catch(function(err) {
                console.error('カメラアクセス拒否:', err);
                document.getElementById('info').innerHTML = 
                    '<h3>カメラが必要</h3><p>WebARを使用するにはカメラへのアクセスを許可してください。</p>';
            });
    </script>
</body>
</html>
